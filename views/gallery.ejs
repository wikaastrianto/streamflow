<% layout('layout') -%>
<% function formatFileSize(bytes) { 
  if (!bytes || bytes === 0) return '0 B';
  bytes = Number(bytes);
  if (isNaN(bytes)) return '0 B';
  if (bytes < 1024) return bytes + ' B';
  else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
  else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
  else if (bytes < 1099511627776) return (bytes / 1073741824).toFixed(2) + ' GB';
  else return (bytes / 1099511627776).toFixed(2) + ' TB';
} 
function formatDuration(seconds) { 
  if (!seconds) return '0:00'; 
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = Math.floor(seconds % 60);
  if (hours > 0) return `${hours}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  return `${minutes}:${secs.toString().padStart(2, '0')}`;
} %>

<div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
  <div>
    <h2 class="text-2xl font-bold">Media Gallery</h2>
    <p class="text-gray-400 text-sm mt-1">
      <span>Manage your videos and audio for streaming</span>
      <span id="diskUsageInfoDesktop" class="hidden">
        <span class="text-gray-500 mx-1">â€¢</span>
        <i class="ti ti-database text-xs"></i>
        <span id="diskUsageTextDesktop" class="text-gray-400"></span>
      </span>
    </p>
    <p id="diskUsageInfoMobile" class="hidden text-gray-400 text-sm mt-1">
      <i class="ti ti-database text-xs mr-1"></i>
      <span id="diskUsageTextMobile"></span>
    </p>
  </div>
  <div class="flex gap-3">
    <button onclick="openUploadModal()" class="flex items-center gap-2 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
      <i class="ti ti-upload"></i>
      <span>Upload Media</span>
    </button>
    <button onclick="openFolderModal()" class="flex items-center gap-2 bg-dark-700 border border-gray-600 hover:bg-dark-600 text-white px-4 py-2 rounded-lg transition-colors">
      <i class="ti ti-folder-plus"></i>
      <span>Create Folder</span>
    </button>
    <div class="relative">
      <button onclick="toggleCloudDropdown()" class="flex items-center gap-2 bg-dark-700 border border-gray-600 hover:bg-dark-600 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="ti ti-cloud-download"></i>
        <span>Import from Cloud</span>
        <i class="ti ti-chevron-down text-sm"></i>
      </button>
      <div id="cloudDropdown" class="hidden absolute right-0 mt-2 w-48 bg-dark-800 border border-gray-700 rounded-lg shadow-xl z-50">
        <button onclick="openCloudModal('gdrive')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-dark-700 transition-colors rounded-t-lg">
          <img src="/images/google drive.png" alt="Google Drive" class="w-5 h-5">
          <span>Google Drive</span>
        </button>
        <button onclick="openCloudModal('mediafire')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-dark-700 transition-colors">
          <img src="/images/mediafire.png" alt="Mediafire" class="w-5 h-5">
          <span>Mediafire</span>
        </button>
        <button onclick="openCloudModal('dropbox')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-dark-700 transition-colors">
          <img src="/images/dropbox.png" alt="Dropbox" class="w-5 h-5">
          <span>Dropbox</span>
        </button>
        <button onclick="openCloudModal('mega')" class="w-full flex items-center gap-3 px-4 py-3 hover:bg-dark-700 transition-colors rounded-b-lg">
          <img src="/images/mega.png" alt="MEGA" class="w-5 h-5">
          <span>MEGA</span>
        </button>
      </div>
    </div>
  </div>
</div>

<div class="bg-gray-800 rounded-lg shadow-md overflow-hidden">
  <div class="flex flex-col sm:flex-row sm:items-center justify-between p-4 border-b border-gray-700 gap-4">
    <div class="flex items-center gap-3">
      <div class="relative w-full sm:w-64">
        <input type="text" id="searchInput" placeholder="Search videos..."
          class="w-full bg-dark-700 border border-gray-600 text-white pl-9 pr-4 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>
      <select id="typeFilter" class="bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        <option value="all">All Media</option>
        <option value="video">Video</option>
        <option value="audio">Audio</option>
      </select>
      <select id="folderFilter" class="bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary" data-folder-select="filter">
        <option value="all">All Folders</option>
        <option value="unassigned">Unsorted</option>
        <% (folders || []).forEach(function(folder) { %>
          <option value="<%= folder.id %>"><%= folder.name %></option>
        <% }); %>
      </select>
      <select id="sortSelect" class="bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="name">Name</option>
        <option value="size">Size</option>
      </select>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex items-center bg-dark-700 border border-gray-600 rounded-lg overflow-hidden">
        <button id="gridViewBtn" class="px-3 py-2 bg-primary text-white" title="Grid view">
          <i class="ti ti-layout-grid"></i>
        </button>
        <button id="listViewBtn" class="px-3 py-2 text-gray-400 hover:text-white transition-colors" title="List view">
          <i class="ti ti-list"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="p-4">
    <% if (videos && videos.length > 0) { %>
    <div id="gridView" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
      <% videos.forEach(function(video) { 
        const isAudio = video.filepath && (video.filepath.includes('/audio/') || video.filepath.endsWith('.m4a') || video.filepath.endsWith('.aac') || video.filepath.endsWith('.mp3'));
        const mediaType = isAudio ? 'audio' : 'video';
      %>
      <div class="file-item group bg-dark-700 rounded-lg overflow-hidden border border-transparent hover:border-gray-600 hover:bg-dark-600 transition-all cursor-pointer"
        data-id="<%= video.id %>" data-title="<%= video.title %>" data-date="<%= video.upload_date %>" data-size="<%= video.file_size %>" data-type="<%= mediaType %>" data-folder-id="<%= video.folder_id || '' %>"
        onclick="playMedia('<%= video.id %>', '<%= video.title %>', '<%= mediaType %>')">
        <div class="aspect-video relative overflow-hidden bg-dark-900">
          <% if (isAudio) { %>
          <div class="w-full h-full flex items-center justify-center bg-[#181818]">
            <div class="w-16 h-16 rounded-full bg-primary/20 flex items-center justify-center">
              <i class="ti ti-music text-3xl text-primary"></i>
            </div>
          </div>
          <% } else { %>
          <img src="<%= video.thumbnail_path %>" alt="<%= video.title %>" class="w-full h-full object-cover">
          <% } %>
          <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
            <div class="bg-primary/90 w-10 h-10 rounded-full flex items-center justify-center">
              <i class="ti ti-player-play-filled text-white"></i>
            </div>
          </div>
          <span class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-1.5 py-0.5 rounded">
            <%= formatDuration(video.duration) %>
          </span>
          <% if (isAudio) { %>
          <span class="absolute top-2 left-2 bg-primary/80 text-white text-xs px-1.5 py-0.5 rounded">
            <i class="ti ti-music text-xs mr-1"></i>Audio
          </span>
          <% } %>
        </div>
        <div class="p-3">
          <h3 class="font-medium text-sm truncate mb-1"><%= video.title %></h3>
          <p class="text-xs text-gray-500 truncate mb-2 flex items-center gap-1">
            <i class="ti ti-folder text-xs"></i>
            <span><%= video.folder_name || 'Unsorted' %></span>
          </p>
          <div class="flex items-center justify-between">
            <span class="text-xs text-gray-400"><%= formatFileSize(video.file_size) %></span>
            <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="text-gray-400 hover:text-white p-1" onclick="event.stopPropagation(); showRenameDialog('<%= video.id %>', '<%= video.title %>')">
                <i class="ti ti-pencil text-sm"></i>
              </button>
              <button class="text-gray-400 hover:text-red-400 p-1" onclick="event.stopPropagation(); showDeleteDialog('<%= video.id %>', '<%= video.title %>')">
                <i class="ti ti-trash text-sm"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
      <% }); %>
    </div>

    <div id="listView" class="hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-700">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Name</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-24">Duration</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-28">Size</th>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-32">Modified</th>
              <th class="px-4 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider w-24">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-700">
            <% videos.forEach(function(video) { 
              const isAudio = video.filepath && (video.filepath.includes('/audio/') || video.filepath.endsWith('.m4a') || video.filepath.endsWith('.aac') || video.filepath.endsWith('.mp3'));
              const mediaType = isAudio ? 'audio' : 'video';
            %>
            <tr class="file-item-row group hover:bg-dark-700 transition-colors cursor-pointer"
              data-id="<%= video.id %>" data-title="<%= video.title %>" data-date="<%= video.upload_date %>" data-size="<%= video.file_size %>" data-type="<%= mediaType %>" data-folder-id="<%= video.folder_id || '' %>"
              onclick="playMedia('<%= video.id %>', '<%= video.title %>', '<%= mediaType %>')">
              <td class="px-4 py-3">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-8 rounded overflow-hidden bg-[#181818] flex-shrink-0 relative flex items-center justify-center">
                    <% if (isAudio) { %>
                    <i class="ti ti-music text-primary"></i>
                    <% } else { %>
                    <img src="<%= video.thumbnail_path %>" alt="" class="w-full h-full object-cover">
                    <% } %>
                  </div>
                  <div>
                    <span class="font-medium text-sm truncate max-w-xs block"><%= video.title %></span>
                    <span class="text-xs text-gray-500 flex items-center gap-1 mt-0.5">
                      <i class="ti ti-folder text-xs"></i>
                      <span class="truncate max-w-xs"><%= video.folder_name || 'Unsorted' %></span>
                    </span>
                  </div>
                </div>
              </td>
              <td class="px-4 py-3 text-sm text-gray-400"><%= formatDuration(video.duration) %></td>
              <td class="px-4 py-3 text-sm text-gray-400"><%= formatFileSize(video.file_size) %></td>
              <td class="px-4 py-3 text-sm text-gray-400"><%= new Date(video.upload_date).toLocaleDateString() %></td>
              <td class="px-4 py-3 text-right">
                <div class="flex items-center justify-end gap-1">
                  <button class="p-1.5 hover:bg-dark-600 rounded text-gray-400 hover:text-white transition-colors"
                    onclick="event.stopPropagation(); showRenameDialog('<%= video.id %>', '<%= video.title %>')">
                    <i class="ti ti-pencil text-sm"></i>
                  </button>
                  <button class="p-1.5 hover:bg-dark-600 rounded text-gray-400 hover:text-red-400 transition-colors"
                    onclick="event.stopPropagation(); showDeleteDialog('<%= video.id %>', '<%= video.title %>')">
                    <i class="ti ti-trash text-sm"></i>
                  </button>
                </div>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
    <% } else { %>
    <div class="text-center py-12">
      <div class="w-16 h-16 rounded-full bg-dark-700 flex items-center justify-center mx-auto mb-4">
        <i class="ti ti-video text-gray-500 text-2xl"></i>
      </div>
      <h3 class="text-lg font-medium text-gray-300 mb-2">No videos yet</h3>
      <p class="text-gray-500 text-sm mb-4">Upload your first video to get started</p>
      <button onclick="openUploadModal()" class="inline-flex items-center gap-2 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
        <i class="ti ti-upload"></i>
        <span>Upload Video</span>
      </button>
    </div>
    <% } %>
  </div>

  <% if (videos && videos.length > 0) { %>
  <div class="px-4 py-3 border-t border-gray-700 flex flex-col sm:flex-row items-center justify-between gap-4">
    <p id="paginationInfo" class="text-sm text-gray-400">Showing 1-<%= Math.min(videos.length, 24) %> of <%= videos.length %> videos</p>
    <div id="paginationControls" class="flex items-center gap-2"></div>
  </div>
  <% } %>
</div>

<div id="uploadModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden modal-overlay overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-lg" id="uploadModalContent">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 class="text-lg font-semibold">Upload Media</h3>
        <button onclick="closeUploadModal()" class="text-gray-400 hover:text-white">
          <i class="ti ti-x text-xl"></i>
        </button>
      </div>
      <div class="p-6">
        <div class="flex gap-2 mb-4">
          <button type="button" id="tabVideo" class="flex-1 py-2 px-4 rounded-lg bg-primary text-white transition-colors" onclick="switchUploadTab('video')">
            <i class="ti ti-video mr-2"></i>Video
          </button>
          <button type="button" id="tabAudio" class="flex-1 py-2 px-4 rounded-lg bg-dark-700 text-gray-400 hover:text-white transition-colors" onclick="switchUploadTab('audio')">
            <i class="ti ti-music mr-2"></i>Audio
          </button>
        </div>
        <form id="videoUploadForm" enctype="multipart/form-data">
          <input type="hidden" name="_csrf" value="<%= csrfToken %>">
          <input type="hidden" name="uploadType" id="uploadType" value="video">
          <div class="mb-4">
            <label for="uploadFolderSelect" class="block text-sm font-medium text-gray-300 mb-2">Folder</label>
            <select id="uploadFolderSelect" class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary" data-folder-select="upload">
              <option value="">Unsorted</option>
              <% (folders || []).forEach(function(folder) { %>
                <option value="<%= folder.id %>"><%= folder.name %></option>
              <% }); %>
            </select>
          </div>
          <div id="uploadDropzone" class="border-2 border-dashed border-gray-600 hover:border-primary rounded-lg py-10 px-6 text-center transition-all cursor-pointer" data-state="idle">
            <div class="flex flex-col items-center justify-center space-y-3">
              <div class="w-14 h-14 rounded-full bg-dark-700 flex items-center justify-center">
                <i id="dropzoneIcon" class="ti ti-cloud-upload text-2xl text-gray-400"></i>
              </div>
              <div>
                <p id="dropzoneText" class="text-gray-300">Drag and drop video files here</p>
                <p class="text-gray-500 text-sm">Or click to browse</p>
              </div>
              <label class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors inline-block cursor-pointer">
                <span>Select files</span>
                <input type="file" name="media" accept="video/mp4,video/avi,video/quicktime" multiple class="hidden" id="mediaFileInput">
              </label>
              <p id="dropzoneFormats" class="text-gray-500 text-xs">Supported formats: MP4, AVI, MOV (max 50GB)</p>
            </div>
          </div>
          <div id="selectedFileInfo" class="hidden">
            <div class="bg-dark-700 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                    <i class="ti ti-files text-primary"></i>
                  </div>
                  <div>
                    <p class="font-medium text-sm">Selected files</p>
                    <p id="selectedFileCount" class="text-xs text-gray-400"></p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button type="button" class="text-primary hover:text-blue-400 text-sm" onclick="document.getElementById('mediaFileInput').click()">Add more</button>
                  <button type="button" id="clearFileButton" class="text-gray-400 hover:text-white p-1">
                    <i class="ti ti-x"></i>
                  </button>
                </div>
              </div>
              <div id="selectedFilesList" class="space-y-2 max-h-48 overflow-y-auto"></div>
            </div>
          </div>
          <div class="mt-4 hidden" id="uploadProgress">
            <div class="flex justify-between items-center text-sm mb-2">
              <span id="uploadProgressStatus" class="text-gray-400 truncate mr-2">Uploading...</span>
              <span id="uploadProgressPercent" class="text-primary font-medium">0%</span>
            </div>
            <div class="w-full bg-dark-700 rounded-full h-2.5">
              <div id="uploadProgressBar" class="bg-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div id="uploadFilesList" class="mt-3 space-y-2 max-h-48 overflow-y-auto"></div>
          </div>
        </form>
      </div>
      <div class="flex justify-end gap-3 p-4 border-t border-gray-700">
        <button onclick="closeUploadModal()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors">Cancel</button>
        <button id="uploadButton" class="px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors disabled:bg-gray-600 disabled:cursor-not-allowed" disabled>
          <i class="ti ti-upload mr-1.5"></i>Upload
        </button>
      </div>
    </div>
  </div>
</div>

<div id="folderModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden modal-overlay overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 class="text-lg font-semibold">Create Folder</h3>
        <button onclick="closeFolderModal()" class="text-gray-400 hover:text-white">
          <i class="ti ti-x text-xl"></i>
        </button>
      </div>
      <div class="p-6 space-y-4">
        <div>
          <label for="folderNameInput" class="block text-sm font-medium text-gray-300 mb-2">Folder Name</label>
          <input type="text" id="folderNameInput" placeholder="Enter folder name..."
            class="w-full bg-dark-700 border border-gray-600 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        </div>
      </div>
      <div class="flex justify-end gap-3 p-4 border-t border-gray-700">
        <button onclick="closeFolderModal()" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors">Cancel</button>
        <button onclick="createFolder()" class="px-4 py-2 bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors">Create</button>
      </div>
    </div>
  </div>
</div>

<div id="cloudImportModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden modal-overlay overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div id="cloudModalContent" class="bg-dark-800 rounded-lg shadow-xl w-full max-w-md">
      <div class="flex items-center justify-between p-4 border-b border-gray-700">
        <h3 id="cloudModalTitle" class="text-lg font-semibold">Import from Cloud</h3>
        <button id="closeCloudBtn" class="text-gray-400 hover:text-white">
          <i class="ti ti-x text-xl"></i>
        </button>
      </div>
      <div id="cloudModalBody"></div>
    </div>
  </div>
</div>

<div id="toast" class="fixed top-16 right-4 bg-dark-800 text-white px-4 py-3 rounded-lg shadow-lg z-50 hidden flex items-center">
  <i id="toast-icon" class="mr-2"></i>
  <span id="toast-message"></span>
</div>


<script>
let currentView = 'grid';
let currentUploadType = 'video';
let userDiskUsage = 0;
let userDiskLimit = 0;
let availableFolders = <%- JSON.stringify(folders || []) %>;

async function loadDiskUsage() {
  try {
    const response = await fetch('/api/user/disk-usage');
    const data = await response.json();
    if (data.success) {
      userDiskUsage = data.diskUsage;
      userDiskLimit = data.diskLimit;
      updateDiskUsageDisplay();
    }
  } catch (error) {
    console.error('Error loading disk usage:', error);
  }
}

function updateDiskUsageDisplay() {
  const infoDesktop = document.getElementById('diskUsageInfoDesktop');
  const textDesktop = document.getElementById('diskUsageTextDesktop');
  const infoMobile = document.getElementById('diskUsageInfoMobile');
  const textMobile = document.getElementById('diskUsageTextMobile');
  
  if (userDiskLimit > 0) {
    const usedText = formatFileSize(userDiskUsage);
    const limitText = formatFileSize(userDiskLimit);
    const displayText = `${usedText} / ${limitText}`;
    
    textDesktop.textContent = displayText;
    textMobile.textContent = displayText;
    
    const isMobile = window.innerWidth < 768;
    if (isMobile) {
      infoDesktop.classList.add('hidden');
      infoMobile.classList.remove('hidden');
    } else {
      infoDesktop.classList.remove('hidden');
      infoMobile.classList.add('hidden');
    }
  } else {
    infoDesktop.classList.add('hidden');
    infoMobile.classList.add('hidden');
  }
}

window.addEventListener('resize', updateDiskUsageDisplay);

function checkDiskLimit(fileSize) {
  if (userDiskLimit === 0) return true;
  return (userDiskUsage + fileSize) <= userDiskLimit;
}

function getRemainingSpace() {
  if (userDiskLimit === 0) return Infinity;
  return Math.max(0, userDiskLimit - userDiskUsage);
}

loadDiskUsage();

function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function switchUploadTab(type) {
  currentUploadType = type;
  document.getElementById('uploadType').value = type;
  const tabVideo = document.getElementById('tabVideo');
  const tabAudio = document.getElementById('tabAudio');
  const dropzoneIcon = document.getElementById('dropzoneIcon');
  const dropzoneText = document.getElementById('dropzoneText');
  const dropzoneFormats = document.getElementById('dropzoneFormats');
  const mediaFileInput = document.getElementById('mediaFileInput');
  
  if (type === 'video') {
    tabVideo.className = 'flex-1 py-2 px-4 rounded-lg bg-primary text-white transition-colors';
    tabAudio.className = 'flex-1 py-2 px-4 rounded-lg bg-dark-700 text-gray-400 hover:text-white transition-colors';
    dropzoneIcon.className = 'ti ti-video text-2xl text-gray-400';
    dropzoneText.textContent = 'Drag and drop video files here';
    dropzoneFormats.textContent = 'Supported formats: MP4, AVI, MOV (max 50GB)';
    mediaFileInput.accept = 'video/mp4,video/avi,video/quicktime';
  } else {
    tabVideo.className = 'flex-1 py-2 px-4 rounded-lg bg-dark-700 text-gray-400 hover:text-white transition-colors';
    tabAudio.className = 'flex-1 py-2 px-4 rounded-lg bg-primary text-white transition-colors';
    dropzoneIcon.className = 'ti ti-music text-2xl text-gray-400';
    dropzoneText.textContent = 'Drag and drop audio files here';
    dropzoneFormats.textContent = 'Supported formats: MP3, WAV';
    mediaFileInput.accept = 'audio/mpeg,audio/mp3,audio/wav,audio/aac,audio/mp4,audio/x-m4a,audio/ogg,audio/flac';
  }
  resetUploadForm();
}

function showToast(type, message) {
  const toast = document.getElementById('toast');
  const toastIcon = document.getElementById('toast-icon');
  const toastMessage = document.getElementById('toast-message');
  if (type === 'success') {
    toastIcon.className = 'ti ti-check text-green-400 text-xl mr-2 font-loaded';
    toast.classList.add('border-l-4', 'border-green-400');
    toast.classList.remove('border-l-4', 'border-red-400', 'border-yellow-400');
  } else if (type === 'error') {
    toastIcon.className = 'ti ti-x text-red-400 text-xl mr-2 font-loaded';
    toast.classList.add('border-l-4', 'border-red-400');
    toast.classList.remove('border-l-4', 'border-green-400', 'border-yellow-400');
  } else if (type === 'warning') {
    toastIcon.className = 'ti ti-alert-triangle text-yellow-400 text-xl mr-2 font-loaded';
    toast.classList.add('border-l-4', 'border-yellow-400');
    toast.classList.remove('border-l-4', 'border-green-400', 'border-red-400');
  }
  toastMessage.textContent = message;
  toast.classList.remove('hidden');
  setTimeout(() => toast.classList.add('hidden'), 3000);
}

function refreshFolderSelects() {
  const selects = document.querySelectorAll('[data-folder-select]');
  selects.forEach(select => {
    const currentValue = select.value;
    const type = select.dataset.folderSelect;
    let options = '';
    if (type === 'filter') {
      options += '<option value="all">All Folders</option>';
      options += '<option value="unassigned">Unsorted</option>';
    } else {
      options += '<option value="">Unsorted</option>';
    }
    options += availableFolders.map(folder => `<option value="${folder.id}">${folder.name}</option>`).join('');
    select.innerHTML = options;
    if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
      select.value = currentValue;
    }
  });
}

function openFolderModal() {
  const modal = document.getElementById('folderModal');
  const input = document.getElementById('folderNameInput');
  if (input) input.value = '';
  document.body.style.overflow = 'hidden';
  modal.classList.remove('hidden');
  requestAnimationFrame(() => modal.classList.add('active'));
  setTimeout(() => input?.focus(), 100);
}

function closeFolderModal() {
  const modal = document.getElementById('folderModal');
  modal.classList.remove('active');
  setTimeout(() => {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }, 200);
}

async function createFolder() {
  const input = document.getElementById('folderNameInput');
  const name = input?.value?.trim();
  if (!name) {
    showToast('error', 'Please enter a folder name');
    return;
  }
  try {
    const response = await fetch('/api/folders', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name })
    });
    const data = await response.json();
    if (data.success) {
      availableFolders.unshift(data.folder);
      refreshFolderSelects();
      closeFolderModal();
      showToast('success', 'Folder created successfully');
    } else {
      showToast('error', data.error || 'Failed to create folder');
    }
  } catch (error) {
    console.error('Error creating folder:', error);
    showToast('error', 'Failed to create folder');
  }
}

function getSelectedFolderId() {
  return document.getElementById('uploadFolderSelect')?.value || '';
}

document.getElementById('gridViewBtn').addEventListener('click', function() {
  currentView = 'grid';
  document.getElementById('gridView').classList.remove('hidden');
  document.getElementById('listView').classList.add('hidden');
  this.classList.add('bg-primary', 'text-white');
  this.classList.remove('text-gray-400');
  document.getElementById('listViewBtn').classList.remove('bg-primary', 'text-white');
  document.getElementById('listViewBtn').classList.add('text-gray-400');
});

document.getElementById('listViewBtn').addEventListener('click', function() {
  currentView = 'list';
  document.getElementById('listView').classList.remove('hidden');
  document.getElementById('gridView').classList.add('hidden');
  this.classList.add('bg-primary', 'text-white');
  this.classList.remove('text-gray-400');
  document.getElementById('gridViewBtn').classList.remove('bg-primary', 'text-white');
  document.getElementById('gridViewBtn').classList.add('text-gray-400');
});

function playMedia(mediaId, mediaTitle, mediaType) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4';
  modal.id = 'media-player-modal';
  
  if (mediaType === 'audio') {
    modal.innerHTML = `
      <div class="relative w-full max-w-lg mx-auto">
        <div class="bg-dark-800 rounded-lg overflow-hidden shadow-xl">
          <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-primary/20 flex items-center justify-center">
                <i class="ti ti-music text-primary"></i>
              </div>
              <h3 class="text-lg font-medium truncate pr-4">${mediaTitle || 'Now Playing'}</h3>
            </div>
            <button id="close-player-btn" class="text-gray-400 hover:text-white">
              <i class="ti ti-x text-xl"></i>
            </button>
          </div>
          <div class="p-6">
            <audio id="audio-player" class="w-full" controls autoplay>
              <source src="/stream/${mediaId}" type="audio/mp4">
              Your browser does not support the audio element.
            </audio>
          </div>
        </div>
      </div>
    `;
  } else {
    modal.innerHTML = `
      <div class="relative w-full max-w-4xl mx-auto">
        <div class="bg-dark-800 rounded-lg overflow-hidden shadow-xl">
          <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <h3 class="text-lg font-medium truncate pr-4">${mediaTitle || 'Now Playing'}</h3>
            <button id="close-player-btn" class="text-gray-400 hover:text-white">
              <i class="ti ti-x text-xl"></i>
            </button>
          </div>
          <div class="bg-black aspect-video">
            <video id="native-player" class="w-full h-full" controls preload="auto" autoplay>
              <source src="/stream/${mediaId}" type="video/mp4">
            </video>
          </div>
        </div>
      </div>
    `;
  }
  
  document.body.appendChild(modal);
  document.body.classList.add('overflow-hidden');
  
  const closePlayer = () => {
    const video = document.getElementById('native-player');
    const audio = document.getElementById('audio-player');
    if (video) video.pause();
    if (audio) audio.pause();
    modal.remove();
    document.body.classList.remove('overflow-hidden');
  };
  
  document.getElementById('close-player-btn').addEventListener('click', closePlayer);
  modal.addEventListener('click', (e) => { if (e.target === modal) closePlayer(); });
  document.addEventListener('keydown', function handler(e) {
    if (e.key === 'Escape') { closePlayer(); document.removeEventListener('keydown', handler); }
  });
}

async function showRenameDialog(videoId, currentTitle) {
  const result = await createModalDialog({
    type: 'info',
    icon: 'ti-pencil',
    title: 'Rename Video',
    message: 'Enter a new title for your video:',
    hasInput: true,
    inputValue: currentTitle,
    confirmText: 'Save'
  });
  if (result.confirmed && result.value && result.value !== currentTitle) {
    try {
      const response = await fetch(`/api/videos/${videoId}/rename`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title: result.value })
      });
      const data = await response.json();
      if (data.success) {
        showToast('success', 'Video renamed successfully');
        setTimeout(() => window.location.reload(), 1000);
      } else {
        showToast('error', data.error || 'Failed to rename video');
      }
    } catch (error) {
      showToast('error', 'An error occurred while renaming the video');
    }
  }
}

async function showDeleteDialog(videoId, videoTitle) {
  const result = await createModalDialog({
    type: 'danger',
    icon: 'ti-trash',
    title: 'Delete Video',
    message: `Are you sure you want to delete "${videoTitle}"? This action cannot be undone.`,
    confirmText: 'Delete',
    confirmClass: 'bg-red-500 hover:bg-red-600'
  });
  if (result.confirmed) {
    try {
      const response = await fetch(`/api/videos/${videoId}`, { method: 'DELETE' });
      const data = await response.json();
      if (data.success) {
        showToast('success', 'Video deleted successfully');
        setTimeout(() => window.location.reload(), 1000);
      } else {
        showToast('error', data.error || 'Failed to delete video');
      }
    } catch (error) {
      showToast('error', 'An error occurred while deleting the video');
    }
  }
}

function createModalDialog(options) {
  const dialog = document.createElement('div');
  dialog.id = 'custom-modal';
  dialog.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm modal-overlay';
  const themes = {
    'info': { icon: options.icon || 'ti-info-circle', color: 'text-primary', bg: 'bg-primary/10', button: 'bg-primary hover:bg-blue-600' },
    'danger': { icon: options.icon || 'ti-alert-triangle', color: 'text-red-400', bg: 'bg-red-500/10', button: 'bg-red-500 hover:bg-red-600' }
  };
  const theme = themes[options.type || 'info'];
  dialog.innerHTML = `
    <div class="max-w-md w-full mx-4">
      <div class="bg-dark-800 rounded-lg shadow-xl overflow-hidden">
        <div class="p-6">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 rounded-full ${theme.bg} flex items-center justify-center shrink-0">
              <i class="ti ${theme.icon} ${theme.color} text-2xl"></i>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold">${options.title}</h3>
              <p class="text-gray-400 text-sm mt-1">${options.message}</p>
            </div>
          </div>
          ${options.hasInput ? `
          <input type="text" id="modal-input" class="mt-4 w-full bg-dark-700 border border-gray-600 text-white px-4 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary" value="${options.inputValue || ''}" autofocus>
          ` : ''}
        </div>
        <div class="flex justify-end gap-3 p-4 border-t border-gray-700">
          <button id="modal-cancel-btn" class="px-4 py-2 bg-dark-700 hover:bg-dark-600 text-gray-300 rounded-lg transition-colors">Cancel</button>
          <button id="modal-confirm-btn" class="${options.confirmClass || theme.button} px-4 py-2 text-white rounded-lg transition-colors">${options.confirmText || 'Confirm'}</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(dialog);
  document.body.classList.add('overflow-hidden');
  
  return new Promise((resolve) => {
    const close = (confirmed = false, value = null) => {
      document.body.classList.remove('overflow-hidden');
      dialog.remove();
      resolve({ confirmed, value });
    };
    document.getElementById('modal-confirm-btn').addEventListener('click', () => {
      const value = options.hasInput ? document.getElementById('modal-input').value : null;
      close(true, value);
    });
    document.getElementById('modal-cancel-btn').addEventListener('click', () => close());
    dialog.addEventListener('click', (e) => { if (e.target === dialog) close(); });
    if (options.hasInput) {
      const input = document.getElementById('modal-input');
      input.focus();
      input.select();
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') close(true, input.value); });
    }
  });
}

function openUploadModal() {
  const modal = document.getElementById('uploadModal');
  modal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  resetUploadForm();
}

function closeUploadModal() {
  const modal = document.getElementById('uploadModal');
  modal.classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
  resetUploadForm();
}

function resetUploadForm() {
  document.getElementById('videoUploadForm').reset();
  document.getElementById('selectedFileInfo').classList.add('hidden');
  document.getElementById('uploadDropzone').classList.remove('hidden');
  document.getElementById('uploadProgress').classList.add('hidden');
  document.getElementById('uploadButton').disabled = true;
  document.getElementById('uploadProgressBar').style.width = '0%';
  document.getElementById('uploadType').value = currentUploadType;
  selectedFiles = [];
}

let currentCloudType = '';

function toggleCloudDropdown() {
  const dropdown = document.getElementById('cloudDropdown');
  dropdown.classList.toggle('hidden');
}

document.addEventListener('click', function(e) {
  const dropdown = document.getElementById('cloudDropdown');
  const button = e.target.closest('button[onclick="toggleCloudDropdown()"]');
  if (!button && !e.target.closest('#cloudDropdown')) {
    dropdown.classList.add('hidden');
  }
});

function openCloudModal(type) {
  currentCloudType = type;
  document.getElementById('cloudDropdown').classList.add('hidden');
  const modal = document.getElementById('cloudImportModal');
  modal.classList.remove('hidden');
  document.body.classList.add('overflow-hidden');
  initCloudModal(type);
}

function closeCloudModal() {
  const modal = document.getElementById('cloudImportModal');
  modal.classList.add('hidden');
  document.body.classList.remove('overflow-hidden');
}

function openGDriveModal() {
  openCloudModal('gdrive');
}

function closeGDriveModal() {
  closeCloudModal();
}

function initCloudModal(type) {
  const configs = {
    gdrive: {
      title: 'Import from Google Drive',
      icon: '/images/google drive.png',
      placeholder: 'https://drive.google.com/file/d/...',
      hint: 'Make sure the file is shared with "Anyone with the link"',
      endpoint: '/api/videos/import-drive',
      urlField: 'driveUrl'
    },
    mediafire: {
      title: 'Import from Mediafire',
      icon: '/images/mediafire.png',
      placeholder: 'https://www.mediafire.com/file/...',
      hint: 'Paste the Mediafire file link',
      endpoint: '/api/videos/import-mediafire',
      urlField: 'mediafireUrl'
    },
    dropbox: {
      title: 'Import from Dropbox',
      icon: '/images/dropbox.png',
      placeholder: 'https://www.dropbox.com/...',
      hint: 'Make sure the file is publicly accessible',
      endpoint: '/api/videos/import-dropbox',
      urlField: 'dropboxUrl'
    },
    mega: {
      title: 'Import from MEGA',
      icon: '/images/mega.png',
      placeholder: 'https://mega.nz/file/...',
      hint: 'Paste the MEGA file link (public files only)',
      endpoint: '/api/videos/import-mega',
      urlField: 'megaUrl'
    }
  };
  
  const config = configs[type];
  document.getElementById('cloudModalTitle').textContent = config.title;
  
  document.getElementById('cloudModalBody').innerHTML = `
    <div class="p-6">
      <div class="text-center mb-6">
        <div class="w-16 h-16 rounded-full bg-dark-700 flex items-center justify-center mx-auto mb-3">
          <img src="${config.icon}" alt="${config.title}" class="w-10 h-10">
        </div>
        <p class="text-gray-400 text-sm">Paste a link to your video</p>
      </div>
      <div class="relative mb-3">
        <input type="text" id="cloud-link" class="w-full bg-dark-700 border border-gray-600 text-white pl-10 pr-4 py-2 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary" placeholder="${config.placeholder}">
        <i class="ti ti-link absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
      </div>
      <p class="text-xs text-gray-500 mb-4">${config.hint}</p>
      <button id="import-cloud-button" class="w-full bg-primary hover:bg-blue-600 text-white py-2 rounded-lg transition-colors flex items-center justify-center">
        <i class="ti ti-download mr-2"></i>
        Import Video
      </button>
    </div>
  `;
  
  document.getElementById('closeCloudBtn').addEventListener('click', closeCloudModal);
  document.getElementById('import-cloud-button').addEventListener('click', async function() {
    const link = document.getElementById('cloud-link').value;
    if (!link) { showToast('error', 'Please enter a link'); return; }
    this.disabled = true;
    this.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
    try {
      const body = {};
      body[config.urlField] = link;
      const response = await fetch(config.endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': document.querySelector('input[name="_csrf"]').value },
        body: JSON.stringify(body)
      });
      const result = await response.json();
      if (result.success) {
        showImportProgress(result.jobId);
        closeCloudModal();
      } else {
        showToast('error', result.error || 'Failed to import video');
        this.disabled = false;
        this.innerHTML = '<i class="ti ti-download mr-2"></i>Import Video';
      }
    } catch (error) {
      showToast('error', 'An error occurred while importing the video');
      this.disabled = false;
      this.innerHTML = '<i class="ti ti-download mr-2"></i>Import Video';
    }
  });
}

function showImportProgress(jobId) {
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm modal-overlay';
  modal.id = 'import-progress-modal';
  modal.innerHTML = `
    <div class="bg-dark-800 rounded-lg p-6 w-full max-w-sm mx-4">
      <div class="text-center">
        <div class="w-16 h-16 mb-4 rounded-full bg-primary/10 mx-auto flex items-center justify-center">
          <i id="progress-icon" class="ti ti-download text-primary text-2xl"></i>
        </div>
        <p id="progress-status" class="text-sm text-gray-300 mb-4">Starting download...</p>
        <div class="w-full bg-dark-700 rounded-full h-2.5 mb-4">
          <div id="progress-bar" class="bg-primary h-2.5 rounded-full transition-all" style="width: 0%"></div>
        </div>
        <button onclick="document.getElementById('import-progress-modal').remove()" class="text-sm text-gray-500 hover:text-white">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  
  const interval = setInterval(async () => {
    try {
      const response = await fetch(`/api/videos/import-status/${jobId}`);
      const data = await response.json();
      if (!data.success) { clearInterval(interval); return; }
      const status = data.status;
      document.getElementById('progress-bar').style.width = `${status.progress}%`;
      document.getElementById('progress-status').textContent = status.message;
      if (status.status === 'complete') {
        document.getElementById('progress-icon').className = 'ti ti-check text-green-400 text-2xl';
        showToast('success', 'Video imported successfully');
        setTimeout(() => window.location.reload(), 1500);
        clearInterval(interval);
      } else if (status.status === 'failed') {
        document.getElementById('progress-icon').className = 'ti ti-x text-red-400 text-2xl';
        showToast('error', status.message || 'Import failed');
        clearInterval(interval);
      }
    } catch (e) { console.error(e); }
  }, 1000);
}


let selectedFiles = [];
const CHUNK_SIZE = 50 * 1024 * 1024;

function isAudioFile(file) {
  const audioTypes = ['audio/mpeg', 'audio/mp3', 'audio/wav', 'audio/x-wav', 'audio/aac', 'audio/mp4', 'audio/x-m4a', 'audio/ogg', 'audio/flac', 'audio/x-flac'];
  const audioExts = ['.mp3', '.wav', '.aac', '.m4a', '.ogg', '.flac'];
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  return audioTypes.includes(file.type) || audioExts.includes(ext);
}

function isVideoFile(file) {
  const videoTypes = ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo'];
  const videoExts = ['.mp4', '.avi', '.mov'];
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  return videoTypes.includes(file.type) || videoExts.includes(ext);
}

document.addEventListener('DOMContentLoaded', function() {
  const mediaFileInput = document.getElementById('mediaFileInput');
  const selectedFileInfo = document.getElementById('selectedFileInfo');
  const selectedFileCount = document.getElementById('selectedFileCount');
  const selectedFilesList = document.getElementById('selectedFilesList');
  const clearFileButton = document.getElementById('clearFileButton');
  const uploadDropzone = document.getElementById('uploadDropzone');
  const uploadButton = document.getElementById('uploadButton');
  const uploadProgress = document.getElementById('uploadProgress');
  const uploadProgressBar = document.getElementById('uploadProgressBar');
  const uploadProgressPercent = document.getElementById('uploadProgressPercent');
  const uploadProgressStatus = document.getElementById('uploadProgressStatus');
  const uploadFilesList = document.getElementById('uploadFilesList');
  const searchInput = document.getElementById('searchInput');
  const sortSelect = document.getElementById('sortSelect');

  if (mediaFileInput) {
    mediaFileInput.addEventListener('change', function() {
      const newFiles = Array.from(this.files);
      if (newFiles.length > 0) {
        const maxSize = 50 * 1024 * 1024 * 1024;
        const large = newFiles.filter(f => f.size > maxSize);
        if (large.length > 0) {
          showToast('error', `File too large: ${large.map(f => f.name).join(', ')}`);
          this.value = '';
          return;
        }
        const totalNewSize = newFiles.reduce((sum, f) => sum + f.size, 0);
        const totalSelectedSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
        if (userDiskLimit > 0 && (userDiskUsage + totalSelectedSize + totalNewSize) > userDiskLimit) {
          const remaining = getRemainingSpace() - totalSelectedSize;
          showToast('error', `Disk limit exceeded. Remaining space: ${formatFileSize(Math.max(0, remaining))}`);
          this.value = '';
          return;
        }
        newFiles.forEach(f => {
          if (!selectedFiles.some(e => e.name === f.name && e.size === f.size)) selectedFiles.push(f);
        });
        updateFilesList();
        uploadDropzone.classList.add('hidden');
        selectedFileInfo.classList.remove('hidden');
        uploadButton.disabled = false;
      }
      this.value = '';
    });
  }

  function updateFilesList() {
    const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
    selectedFileCount.textContent = `${selectedFiles.length} file${selectedFiles.length > 1 ? 's' : ''} selected (${formatFileSize(totalSize)})`;
    selectedFilesList.innerHTML = '';
    selectedFiles.forEach((file, i) => {
      const isAudio = isAudioFile(file);
      const icon = isAudio ? 'ti-music' : 'ti-video';
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-dark-600 transition-colors';
      div.innerHTML = `
        <div class="flex items-center gap-3 min-w-0">
          <div class="w-8 h-8 rounded bg-dark-600 flex items-center justify-center shrink-0">
            <i class="ti ${icon} text-gray-400 text-sm"></i>
          </div>
          <div class="min-w-0">
            <p class="text-sm truncate">${file.name}</p>
            <p class="text-xs text-gray-500">${formatFileSize(file.size)}</p>
          </div>
        </div>
        <button type="button" class="text-gray-400 hover:text-red-400 p-1" data-index="${i}">
          <i class="ti ti-x text-sm"></i>
        </button>
      `;
      div.querySelector('button').addEventListener('click', () => {
        selectedFiles.splice(i, 1);
        if (selectedFiles.length > 0) updateFilesList();
        else resetUploadForm();
      });
      selectedFilesList.appendChild(div);
    });
  }

  if (clearFileButton) clearFileButton.addEventListener('click', resetUploadForm);

  if (uploadButton) {
    uploadButton.addEventListener('click', async function() {
      if (selectedFiles.length === 0) return;
      uploadDropzone.classList.add('hidden');
      selectedFileInfo.classList.add('hidden');
      uploadProgress.classList.remove('hidden');
      uploadButton.disabled = true;
      
      let success = 0, failed = [];
      uploadFilesList.innerHTML = '';
      selectedFiles.forEach((f) => {
        const isAudio = isAudioFile(f);
        const icon = isAudio ? 'ti-music' : 'ti-video';
        const div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 rounded-lg';
        div.innerHTML = `
          <div class="flex items-center gap-3 min-w-0">
            <div class="w-8 h-8 rounded bg-dark-600 flex items-center justify-center shrink-0">
              <i class="ti ${icon} text-gray-400 text-sm"></i>
            </div>
            <span class="text-sm truncate">${f.name}</span>
          </div>
          <span class="file-status text-xs text-gray-500">Waiting</span>
        `;
        uploadFilesList.appendChild(div);
      });

      for (let i = 0; i < selectedFiles.length; i++) {
        const file = selectedFiles[i];
        const isAudio = isAudioFile(file);
        uploadProgressStatus.textContent = `Uploading ${i + 1}/${selectedFiles.length}: ${file.name}`;
        updateFileProgress(i, 'uploading', 0);
        
        let result;
        if (isAudio) {
          result = await uploadAudioSimple(file, i, selectedFiles.length);
        } else {
          const useChunked = file.size > 50 * 1024 * 1024;
          result = useChunked ? await uploadChunked(file, i, selectedFiles.length) : await uploadSimple(file, i, selectedFiles.length);
        }
        
        if (result.success) { success++; updateFileProgress(i, 'success', 100); }
        else { failed.push(file.name); updateFileProgress(i, 'error', 0); }
      }

      if (failed.length === 0) showToast('success', `${success} file${success > 1 ? 's' : ''} uploaded successfully`);
      else showToast('warning', `${success} uploaded, ${failed.length} failed`);
      setTimeout(() => window.location.reload(), 2000);
    });
  }

  function updateFileProgress(index, status, percent) {
    const items = uploadFilesList.children;
    if (items[index]) {
      const el = items[index].querySelector('.file-status');
      if (status === 'uploading') { el.textContent = `${percent}%`; el.className = 'file-status text-xs text-primary'; }
      else if (status === 'success') { el.textContent = 'âœ“'; el.className = 'file-status text-xs text-green-400'; }
      else if (status === 'error') { el.textContent = 'âœ—'; el.className = 'file-status text-xs text-red-400'; }
    }
  }

  async function uploadSimple(file, index, total) {
    return new Promise((resolve) => {
      const formData = new FormData();
      formData.append('video', file);
      const folderId = getSelectedFolderId();
      if (folderId) formData.append('folderId', folderId);
      const xhr = new XMLHttpRequest();
      xhr.timeout = 30 * 60 * 1000;
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          const overall = Math.round(((index + e.loaded / e.total) / total) * 100);
          uploadProgressBar.style.width = overall + '%';
          uploadProgressPercent.textContent = overall + '%';
          updateFileProgress(index, 'uploading', pct);
        }
      });
      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          try { const r = JSON.parse(xhr.responseText); resolve({ success: r.success }); }
          catch { resolve({ success: false }); }
        } else resolve({ success: false });
      });
      xhr.addEventListener('error', () => resolve({ success: false }));
      xhr.addEventListener('timeout', () => resolve({ success: false }));
      xhr.open('POST', '/api/videos/upload', true);
      xhr.send(formData);
    });
  }

  async function uploadAudioSimple(file, index, total) {
    return new Promise((resolve) => {
      const formData = new FormData();
      formData.append('audio', file);
      const folderId = getSelectedFolderId();
      if (folderId) formData.append('folderId', folderId);
      const xhr = new XMLHttpRequest();
      xhr.timeout = 60 * 60 * 1000;
      xhr.upload.addEventListener('progress', (e) => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          const overall = Math.round(((index + e.loaded / e.total) / total) * 100);
          uploadProgressBar.style.width = overall + '%';
          uploadProgressPercent.textContent = overall + '%';
          updateFileProgress(index, 'uploading', pct);
        }
      });
      xhr.addEventListener('load', () => {
        if (xhr.status === 200) {
          try { const r = JSON.parse(xhr.responseText); resolve({ success: r.success }); }
          catch { resolve({ success: false }); }
        } else resolve({ success: false });
      });
      xhr.addEventListener('error', () => resolve({ success: false }));
      xhr.addEventListener('timeout', () => resolve({ success: false }));
      xhr.open('POST', '/api/audio/upload', true);
      xhr.send(formData);
    });
  }

  async function uploadChunked(file, index, total) {
    const totalChunks = Math.ceil(file.size / CHUNK_SIZE);
    try {
      const folderId = getSelectedFolderId();
      const init = await fetch('/api/videos/chunk/init', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename: file.name, fileSize: file.size, totalChunks, folderId })
      });
      const initData = await init.json();
      if (!initData.success) throw new Error(initData.error);
      const uploadId = initData.uploadId;
      let uploaded = initData.uploadedChunks || [];

      for (let i = 0; i < totalChunks; i++) {
        if (uploaded.includes(i)) continue;
        const start = i * CHUNK_SIZE;
        const end = Math.min(start + CHUNK_SIZE, file.size);
        const chunk = file.slice(start, end);
        let retries = 3;
        while (retries > 0) {
          try {
            const res = await fetch('/api/videos/chunk/upload', {
              method: 'POST',
              headers: { 'Content-Type': 'application/octet-stream', 'X-Upload-Id': uploadId, 'X-Chunk-Index': i.toString() },
              body: chunk
            });
            const data = await res.json();
            if (data.success) { uploaded = data.uploadedChunks; break; }
            throw new Error(data.error);
          } catch { retries--; if (retries === 0) throw new Error('Upload failed'); await new Promise(r => setTimeout(r, 1000)); }
        }
        const bytes = Math.min((i + 1) * CHUNK_SIZE, file.size);
        const pct = Math.round((bytes / file.size) * 100);
        const overall = Math.round(((index + bytes / file.size) / total) * 100);
        uploadProgressBar.style.width = overall + '%';
        uploadProgressPercent.textContent = overall + '%';
        updateFileProgress(index, 'uploading', pct);
      }

      const complete = await fetch('/api/videos/chunk/complete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uploadId })
      });
      const completeData = await complete.json();
      return { success: completeData.success };
    } catch (e) {
      console.error(e);
      return { success: false };
    }
  }

  if (uploadDropzone) {
    uploadDropzone.addEventListener('click', (e) => {
      if (!e.target.closest('label')) mediaFileInput.click();
    });
    uploadDropzone.addEventListener('dragenter', (e) => { e.preventDefault(); uploadDropzone.classList.add('border-primary', 'bg-primary/5'); });
    uploadDropzone.addEventListener('dragover', (e) => { e.preventDefault(); });
    uploadDropzone.addEventListener('dragleave', (e) => { e.preventDefault(); uploadDropzone.classList.remove('border-primary', 'bg-primary/5'); });
    uploadDropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadDropzone.classList.remove('border-primary', 'bg-primary/5');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const validFiles = Array.from(files).filter(f => {
          if (currentUploadType === 'video') return isVideoFile(f);
          return isAudioFile(f);
        });
        if (validFiles.length > 0) {
          const totalNewSize = validFiles.reduce((sum, f) => sum + f.size, 0);
          const totalSelectedSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
          if (userDiskLimit > 0 && (userDiskUsage + totalSelectedSize + totalNewSize) > userDiskLimit) {
            const remaining = getRemainingSpace() - totalSelectedSize;
            showToast('error', `Disk limit exceeded. Remaining space: ${formatFileSize(Math.max(0, remaining))}`);
            return;
          }
          validFiles.forEach(f => { if (!selectedFiles.some(e => e.name === f.name && e.size === f.size)) selectedFiles.push(f); });
          updateFilesList();
          uploadDropzone.classList.add('hidden');
          selectedFileInfo.classList.remove('hidden');
          uploadButton.disabled = false;
        } else {
          if (currentUploadType === 'video') showToast('error', 'Please upload a valid video file (MP4, AVI, MOV)');
          else showToast('error', 'Please upload a valid audio file (MP3, WAV, AAC, M4A, OGG, FLAC)');
        }
      }
    });
  }

  const gridItems = document.querySelectorAll('.file-item');
  const listItems = document.querySelectorAll('.file-item-row');
  const itemsPerPage = 18;
  let currentPage = 1;
  let filteredGridItems = [...gridItems];
  let filteredListItems = [...listItems];

  function getItemData(item) {
    return {
      id: item.dataset.id,
      title: item.dataset.title || '',
      date: new Date(item.dataset.date || 0).getTime(),
      size: parseInt(item.dataset.size) || 0,
      type: item.dataset.type || 'video',
      folderId: item.dataset.folderId || ''
    };
  }

  function filterAndSort() {
    const search = searchInput ? searchInput.value.toLowerCase() : '';
    const sort = sortSelect ? sortSelect.value : 'newest';
    const typeFilter = document.getElementById('typeFilter');
    const type = typeFilter ? typeFilter.value : 'all';
    const folderFilter = document.getElementById('folderFilter');
    const folderValue = folderFilter ? folderFilter.value : 'all';
    
    const filterFn = (item) => {
      const data = getItemData(item);
      const matchesSearch = data.title.toLowerCase().includes(search);
      const matchesType = type === 'all' || data.type === type;
      const matchesFolder = folderValue === 'all'
        || (folderValue === 'unassigned' && !data.folderId)
        || (folderValue !== 'unassigned' && data.folderId === folderValue);
      return matchesSearch && matchesType && matchesFolder;
    };

    const sortFn = (a, b) => {
      const dataA = getItemData(a);
      const dataB = getItemData(b);
      
      switch (sort) {
        case 'oldest':
          return dataA.date - dataB.date;
        case 'newest':
          return dataB.date - dataA.date;
        case 'name':
          return dataA.title.localeCompare(dataB.title);
        case 'size':
          return dataB.size - dataA.size;
        default:
          return dataB.date - dataA.date;
      }
    };

    filteredGridItems = [...gridItems].filter(filterFn).sort(sortFn);
    filteredListItems = [...listItems].filter(filterFn).sort(sortFn);

    const gridContainer = document.getElementById('gridView');
    const listContainer = document.querySelector('#listView tbody');
    
    filteredGridItems.forEach(item => gridContainer.appendChild(item));
    filteredListItems.forEach(item => listContainer.appendChild(item));

    currentPage = 1;
    renderPage();
  }

  function renderPage() {
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    
    gridItems.forEach(item => item.style.display = 'none');
    listItems.forEach(item => item.style.display = 'none');
    
    filteredGridItems.slice(start, end).forEach(item => item.style.display = '');
    filteredListItems.slice(start, end).forEach(item => item.style.display = '');
    
    const totalItems = filteredGridItems.length;
    const info = document.getElementById('paginationInfo');
    if (info) info.textContent = totalItems > 0 ? `Showing ${start + 1}-${Math.min(end, totalItems)} of ${totalItems} items` : 'No items found';
    
    renderPagination();
  }

  function renderPagination() {
    const container = document.getElementById('paginationControls');
    if (!container) return;
    const totalPages = Math.ceil(filteredGridItems.length / itemsPerPage);
    container.innerHTML = '';
    
    if (totalPages <= 1) return;
    
    const prev = document.createElement('button');
    prev.className = `w-9 h-9 flex items-center justify-center rounded-lg ${currentPage === 1 ? 'bg-dark-700 text-gray-600 cursor-not-allowed' : 'bg-dark-700 hover:bg-dark-600 text-gray-400 hover:text-white transition-colors'}`;
    prev.innerHTML = '<i class="ti ti-chevron-left"></i>';
    prev.disabled = currentPage === 1;
    prev.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderPage(); } });
    container.appendChild(prev);

    let startPage = Math.max(1, currentPage - 2);
    let endPage = Math.min(totalPages, startPage + 4);
    if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

    for (let i = startPage; i <= endPage; i++) {
      const btn = document.createElement('button');
      btn.className = `w-9 h-9 flex items-center justify-center rounded-lg ${i === currentPage ? 'bg-primary text-white' : 'bg-dark-700 hover:bg-dark-600 text-gray-400 hover:text-white transition-colors'}`;
      btn.textContent = i;
      btn.addEventListener('click', () => { currentPage = i; renderPage(); });
      container.appendChild(btn);
    }

    const next = document.createElement('button');
    next.className = `w-9 h-9 flex items-center justify-center rounded-lg ${currentPage === totalPages ? 'bg-dark-700 text-gray-600 cursor-not-allowed' : 'bg-dark-700 hover:bg-dark-600 text-gray-400 hover:text-white transition-colors'}`;
    next.innerHTML = '<i class="ti ti-chevron-right"></i>';
    next.disabled = currentPage === totalPages;
    next.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderPage(); } });
    container.appendChild(next);
  }

  if (searchInput) searchInput.addEventListener('input', filterAndSort);
  if (sortSelect) sortSelect.addEventListener('change', filterAndSort);
  const typeFilter = document.getElementById('typeFilter');
  if (typeFilter) typeFilter.addEventListener('change', filterAndSort);
  const folderFilter = document.getElementById('folderFilter');
  if (folderFilter) folderFilter.addEventListener('change', filterAndSort);
  
  if (gridItems.length > 0) filterAndSort();
});
</script>

<style>
* { scrollbar-width: thin; scrollbar-color: rgba(156, 163, 175, 0.3) transparent; }
::-webkit-scrollbar { width: 5px; height: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.3); border-radius: 20px; }
::-webkit-scrollbar-thumb:hover { background-color: rgba(156, 163, 175, 0.5); }
.audio-visualizer { animation: pulse 2s ease-in-out infinite; }
@keyframes pulse {
  0%, 100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
}
</style>
