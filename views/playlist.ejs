<% layout('layout') -%>

<div class="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-4">
  <div>
    <h2 class="text-2xl font-bold">Playlist Manager</h2>
    <p class="text-gray-400 text-sm mt-1">Create and manage playlists for streaming</p>
  </div>
  <div class="flex flex-wrap gap-3">
    <button onclick="openCreatePlaylistModal()"
      class="w-full md:w-auto flex items-center justify-center gap-2 bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
      <i class="ti ti-plus"></i>
      <span>Create Playlist</span>
    </button>
  </div>
</div>

<div class="bg-gray-800 rounded-lg p-4 mb-6">
  <div class="flex flex-row items-center gap-3">
    <div class="relative w-full sm:w-80 md:w-96">
      <input type="text" id="searchPlaylists" placeholder="Search playlists..."
        class="w-full bg-dark-700 text-white pl-9 pr-4 py-2.5 border border-gray-600 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
      <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
    </div>
    <div class="w-32">
      <select id="sortPlaylists"
        class="w-full bg-dark-700 border border-gray-600 text-white px-3 py-2.5 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary">
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="name">Name</option>
      </select>
    </div>
  </div>
</div>

<div id="playlistsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
  <% if (playlists && playlists.length > 0) { %>
    <% playlists.forEach(function(playlist) { 
      const thumbnails = playlist.thumbnails ? playlist.thumbnails.split(',').filter(t => t) : [];
      const displayThumbnails = thumbnails.slice(0, 4);
      const audioCount = playlist.audio_count || 0;
    %>
      <div class="bg-gray-800 rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow playlist-card flex flex-col" 
           data-playlist-id="<%= playlist.id %>" 
           data-created-at="<%= playlist.created_at %>" 
           data-updated-at="<%= playlist.updated_at %>">
        <div class="p-4 flex-1">
          <h3 class="font-semibold text-md truncate mb-3"><%= playlist.name %></h3>
          
          <div class="mb-3">
            <% if (displayThumbnails.length > 0) { %>
              <div class="grid grid-cols-4 gap-1.5">
                <% displayThumbnails.forEach(function(thumb) { %>
                  <div class="aspect-square bg-dark-700 rounded-lg overflow-hidden">
                    <img src="<%= thumb %>" alt="Video thumbnail" class="w-full h-full object-cover" onerror="this.src='/images/default-thumbnail.jpg'">
                  </div>
                <% }); %>
                <% for(let i = displayThumbnails.length; i < 4; i++) { %>
                  <div class="aspect-square bg-dark-700 rounded-lg"></div>
                <% } %>
              </div>
            <% } else { %>
              <div class="aspect-[4/1] bg-dark-700 rounded-lg flex items-center justify-center">
                <i class="ti ti-playlist text-4xl text-gray-600"></i>
              </div>
            <% } %>
          </div>
          
          <p class="text-gray-400 text-sm line-clamp-1"><%= playlist.description || 'No description' %></p>
        </div>
        <div class="border-t border-gray-700 px-3 py-2 flex items-center justify-between">
          <div class="flex items-center gap-2 text-xs text-gray-400">
            <span class="flex items-center gap-1">
              <i class="ti ti-video text-sm"></i>
              <%= playlist.video_count || 0 %>
            </span>
            <% if (audioCount > 0) { %>
            <span class="flex items-center gap-1">
              <i class="ti ti-music text-sm"></i>
              <%= audioCount %>
            </span>
            <% } %>
            <span class="flex items-center gap-1">
              <i class="ti ti-<%= (playlist.shuffle || playlist.is_shuffle) ? 'arrows-shuffle' : 'list-numbers' %> text-sm"></i>
            </span>
          </div>
          <div class="flex items-center gap-1.5">
            <button class="p-1 hover:bg-dark-700 rounded transition-colors" onclick="viewPlaylist('<%= playlist.id %>')" title="View">
              <i class="ti ti-eye text-gray-400 hover:text-white text-sm"></i>
            </button>
            <button class="p-1 hover:bg-dark-700 rounded transition-colors" onclick="editPlaylist('<%= playlist.id %>')" title="Edit">
              <i class="ti ti-edit text-gray-400 hover:text-white text-sm"></i>
            </button>
            <button class="p-1 hover:bg-dark-700 rounded transition-colors" onclick="deletePlaylist('<%= playlist.id %>', '<%= playlist.name %>')" title="Delete">
              <i class="ti ti-trash text-gray-400 hover:text-red-400 text-sm"></i>
            </button>
          </div>
        </div>
      </div>
    <% }); %>
  <% } else { %>
    <div class="col-span-full text-center py-12">
      <i class="ti ti-playlist text-6xl text-gray-600 mb-4"></i>
      <h3 class="text-xl font-semibold mb-2">No playlists yet</h3>
      <p class="text-gray-400 mb-4">Create your first playlist to get started</p>
      <button onclick="openCreatePlaylistModal()" 
        class="bg-primary hover:bg-blue-600 text-white px-6 py-3 rounded-lg transition-colors">
        <i class="ti ti-plus mr-2"></i>
        Create Playlist
      </button>
    </div>
  <% } %>
</div>

<div class="mt-6 flex items-center justify-between">
  <p class="text-sm text-gray-400" id="paginationInfo">Showing 1-<%= Math.min(8, playlists ? playlists.length : 0) %> of <%= playlists ? playlists.length : 0 %> playlists</p>
  <div class="flex items-center gap-2" id="paginationControls"></div>
</div>

<div id="playlistModal" class="fixed inset-0 bg-black/50 z-50 hidden modal-overlay overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-5xl modal-container flex flex-col max-h-[90vh]">
      <div class="flex-shrink-0 flex items-center justify-between p-4 sm:px-6 sm:py-4 border-b border-gray-700">
        <h3 id="modalTitle" class="text-lg font-semibold">Create New Playlist</h3>
        <button onclick="closePlaylistModal()" class="text-gray-400 hover:text-white">
          <i class="ti ti-x text-xl"></i>
        </button>
      </div>
      <div class="p-4 sm:px-6 overflow-y-auto flex-grow">
        <form id="playlistForm" class="space-y-6">
          <input type="hidden" id="playlistId" name="playlistId">
          
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="playlistName" class="block text-sm font-medium mb-2">Playlist Name</label>
              <input type="text" id="playlistName" name="name" required placeholder="Enter playlist name..."
                class="w-full bg-dark-700 text-white px-4 py-2.5 border border-gray-600 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
            </div>
            <div>
              <label for="playlistShuffle" class="text-sm font-medium mb-2 flex items-center gap-1">
                Video Playback
                <div class="relative group">
                  <i class="ti ti-help text-gray-400 hover:text-primary cursor-help text-xs"></i>
                  <div class="absolute left-full top-1/2 -translate-y-1/2 ml-2 hidden group-hover:block w-48 p-2 bg-dark-600 text-xs text-gray-200 rounded-md shadow-lg z-10">
                    <div><strong>Sequential:</strong> Videos play in order</div>
                    <div><strong>Shuffle:</strong> Videos play randomly</div>
                  </div>
                </div>
              </label>
              <select id="playlistShuffle" name="shuffle"
                class="w-full bg-dark-700 border border-gray-600 text-white px-4 py-2.5 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
                <option value="false">Sequential</option>
                <option value="true">Shuffle</option>
              </select>
            </div>
            <div>
              <label for="playlistDescription" class="block text-sm font-medium mb-2">Description (Optional)</label>
              <input type="text" id="playlistDescription" name="description" placeholder="Short description..."
                class="w-full bg-dark-700 text-white px-4 py-2.5 border border-gray-600 rounded-lg focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary">
            </div>
          </div>

          <div class="border-b border-gray-700 mb-4">
            <div class="flex flex-wrap -mb-px">
              <button type="button" id="tabVideos" onclick="switchTab('videos')"
                class="modal-tab active mr-2 py-2 px-4 text-primary border-b-2 border-primary font-medium hover:text-white hover:border-gray-700">
                <i class="ti ti-video mr-2"></i>Videos
                <span id="videoCountBadge" class="ml-1 bg-primary/20 text-primary text-xs px-2 py-0.5 rounded-full">0</span>
              </button>
              <button type="button" id="tabAudios" onclick="switchTab('audios')"
                class="modal-tab mr-2 py-2 px-4 text-gray-400 hover:text-white border-b-2 border-transparent hover:border-gray-700 font-medium">
                <i class="ti ti-music mr-2"></i>Background Music
                <span id="audioCountBadge" class="ml-1 bg-gray-700 text-gray-400 text-xs px-2 py-0.5 rounded-full">0</span>
              </button>
            </div>
          </div>

          <div id="videosTab">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h4 class="text-sm font-medium text-gray-300">Available Videos</h4>
                  <span class="text-xs text-gray-500"><%= videos ? videos.length : 0 %> total</span>
                </div>
                <div class="bg-dark-700 rounded-lg border border-gray-600">
                  <div class="p-2 border-b border-gray-600/50">
                    <div class="relative">
                      <input type="text" id="searchVideos" placeholder="Search videos..."
                        class="w-full bg-dark-800 text-white pl-8 pr-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary border border-gray-700">
                      <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                      <select id="videoFolderFilter" class="flex-1 bg-dark-800 text-white px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary border border-gray-700">
                        <option value="all">All folders</option>
                        <option value="unassigned">Unsorted</option>
                        <% (folders || []).forEach(function(folder) { %>
                          <option value="<%= folder.id %>"><%= folder.name %></option>
                        <% }); %>
                      </select>
                      <button type="button" onclick="addFolderVideos()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 text-gray-200 rounded-lg text-xs flex items-center gap-1">
                        <i class="ti ti-folder"></i>
                        <span>Add folder</span>
                      </button>
                    </div>
                  </div>
                  <div id="availableVideos" class="p-2 space-y-1 max-h-64 overflow-y-auto custom-scrollbar">
                    <% if (videos && videos.length > 0) { %>
                      <% videos.forEach(function(video) { %>
                        <button type="button" class="w-full flex items-center gap-2 p-2 rounded hover:bg-dark-600 transition-colors text-left" 
                                data-video-id="<%= video.id %>" onclick="addVideoToPlaylist('<%= video.id %>')">
                          <div class="w-14 h-10 bg-dark-800 rounded flex-shrink-0 overflow-hidden">
                            <img src="<%= video.thumbnail_path %>" alt="<%= video.title %>" class="w-full h-full object-cover" onerror="this.src='/images/default-thumbnail.jpg'">
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate"><%= video.title %></p>
                            <p class="text-xs text-gray-400"><%= video.duration ? Math.floor(video.duration / 60) + ':' + String(Math.floor(video.duration % 60)).padStart(2, '0') : '0:00' %></p>
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                              <i class="ti ti-folder text-xs"></i>
                              <span class="truncate"><%= video.folder_name || 'Unsorted' %></span>
                            </p>
                          </div>
                          <i class="ti ti-plus text-gray-400"></i>
                        </button>
                      <% }); %>
                    <% } else { %>
                      <div class="text-center py-8 text-gray-400">
                        <i class="ti ti-video-off text-3xl mb-2"></i>
                        <p class="text-sm">No videos available</p>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h4 class="text-sm font-medium text-gray-300">Selected Videos</h4>
                  <button type="button" onclick="clearAllVideos()" class="text-xs text-red-400 hover:text-red-300">Clear all</button>
                </div>
                <div class="bg-dark-700 rounded-lg border border-gray-600 border-dashed" id="selectedVideosContainer">
                  <div id="selectedVideos" class="p-2 space-y-1 max-h-64 overflow-y-auto custom-scrollbar min-h-[200px]">
                    <div id="noVideosMessage" class="text-center py-8 text-gray-400">
                      <i class="ti ti-playlist text-3xl mb-2"></i>
                      <p class="text-sm">Drag videos here or click to add</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div id="audiosTab" class="hidden">  
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h4 class="text-sm font-medium text-gray-300">Available Audio</h4>
                  <span class="text-xs text-gray-500"><%= audios ? audios.length : 0 %> total</span>
                </div>
                <div class="bg-dark-700 rounded-lg border border-gray-600">
                  <div class="p-2 border-b border-gray-600/50">
                    <div class="relative">
                      <input type="text" id="searchAudios" placeholder="Search audio..."
                        class="w-full bg-dark-800 text-white pl-8 pr-4 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary border border-gray-700">
                      <i class="ti ti-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div class="mt-2 flex items-center gap-2">
                      <select id="audioFolderFilter" class="flex-1 bg-dark-800 text-white px-3 py-2 rounded-lg text-sm focus:outline-none focus:ring-1 focus:ring-primary border border-gray-700">
                        <option value="all">All folders</option>
                        <option value="unassigned">Unsorted</option>
                        <% (folders || []).forEach(function(folder) { %>
                          <option value="<%= folder.id %>"><%= folder.name %></option>
                        <% }); %>
                      </select>
                      <button type="button" onclick="addFolderAudios()" class="px-3 py-2 bg-dark-700 hover:bg-dark-600 text-gray-200 rounded-lg text-xs flex items-center gap-1">
                        <i class="ti ti-folder"></i>
                        <span>Add folder</span>
                      </button>
                    </div>
                  </div>
                  <div id="availableAudios" class="p-2 space-y-1 max-h-64 overflow-y-auto custom-scrollbar">
                    <% if (audios && audios.length > 0) { %>
                      <% audios.forEach(function(audio) { %>
                        <button type="button" class="w-full flex items-center gap-2 p-2 rounded hover:bg-dark-600 transition-colors text-left" 
                                data-audio-id="<%= audio.id %>" onclick="addAudioToPlaylist('<%= audio.id %>')">
                          <div class="w-10 h-10 bg-dark-800 rounded-full flex-shrink-0 flex items-center justify-center">
                            <i class="ti ti-music text-gray-400"></i>
                          </div>
                          <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-white truncate"><%= audio.title %></p>
                            <p class="text-xs text-gray-400"><%= audio.duration ? Math.floor(audio.duration / 60) + ':' + String(Math.floor(audio.duration % 60)).padStart(2, '0') : '0:00' %></p>
                            <p class="text-xs text-gray-500 flex items-center gap-1">
                              <i class="ti ti-folder text-xs"></i>
                              <span class="truncate"><%= audio.folder_name || 'Unsorted' %></span>
                            </p>
                          </div>
                          <i class="ti ti-plus text-gray-400"></i>
                        </button>
                      <% }); %>
                    <% } else { %>
                      <div class="text-center py-8 text-gray-400">
                        <i class="ti ti-music-off text-3xl mb-2"></i>
                        <p class="text-sm">No audio files available</p>
                        <a href="/gallery" class="text-xs text-primary hover:underline mt-1 inline-block">Upload audio in Gallery</a>
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>
              
              <div>
                <div class="flex items-center justify-between mb-2">
                  <h4 class="text-sm font-medium text-gray-300">Selected Background Music</h4>
                  <button type="button" onclick="clearAllAudios()" class="text-xs text-red-400 hover:text-red-300">Clear all</button>
                </div>
                <div class="bg-dark-700 rounded-lg border border-gray-600 border-dashed" id="selectedAudiosContainer">
                  <div id="selectedAudios" class="p-2 space-y-1 max-h-64 overflow-y-auto custom-scrollbar min-h-[200px]">
                    <div id="noAudiosMessage" class="text-center py-8 text-gray-400">
                      <i class="ti ti-music text-3xl mb-2"></i>
                      <p class="text-sm">No background music selected</p>
                      <p class="text-xs text-gray-500 mt-1">This is optional</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="flex-shrink-0 flex items-center justify-between p-4 sm:px-6 border-t border-gray-700">
        <div class="flex items-center gap-4 text-sm text-gray-400">
          <span class="flex items-center gap-1"><i class="ti ti-video"></i> <span id="summaryVideos">0</span> videos</span>
          <span class="flex items-center gap-1"><i class="ti ti-music"></i> <span id="summaryAudios">0</span> audio</span>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" onclick="closePlaylistModal()" class="px-5 py-2.5 text-sm font-medium text-gray-300 hover:text-white transition-colors">Cancel</button>
          <button type="button" onclick="submitPlaylist()" class="px-5 py-2.5 text-sm font-medium bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors">
            <span id="submitButtonText">Create Playlist</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="viewPlaylistModal" class="fixed inset-0 bg-black/50 z-50 hidden modal-overlay overflow-y-auto">
  <div class="flex min-h-screen items-center justify-center p-4">
    <div class="bg-dark-800 rounded-lg shadow-xl w-full max-w-4xl modal-container flex flex-col max-h-[90vh]">
      <div class="flex-shrink-0 flex items-start justify-between p-4 sm:px-6 sm:py-4 border-b border-gray-700">
        <div>
          <h3 id="viewPlaylistTitle" class="text-lg font-semibold">Playlist Details</h3>
          <p id="viewPlaylistDescription" class="text-gray-400 text-sm mt-1"></p>
        </div>
        <button onclick="closeViewPlaylistModal()" class="text-gray-400 hover:text-white">
          <i class="ti ti-x text-xl"></i>
        </button>
      </div>
      <div class="p-4 sm:px-6 overflow-y-auto flex-grow">
        <div class="mb-4 flex items-center justify-between">
          <div class="flex items-center gap-4 text-sm text-gray-400">
            <span id="viewVideoCount" class="flex items-center gap-1"><i class="ti ti-video"></i> 0 videos</span>
            <span id="viewAudioCount" class="flex items-center gap-1"><i class="ti ti-music"></i> 0 audio</span>
            <span id="viewPlaybackMode" class="flex items-center gap-1"><i class="ti ti-list-numbers"></i> Sequential</span>
          </div>
        </div>
        
        <div class="space-y-4">
          <div>
            <h4 class="text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
              <i class="ti ti-video"></i> Videos
            </h4>
            <div id="playlistVideos" class="space-y-2"></div>
          </div>
          
          <div id="playlistAudiosSection" class="hidden">
            <h4 class="text-sm font-medium text-gray-300 mb-2 flex items-center gap-2">
              <i class="ti ti-music"></i> Background Music
            </h4>
            <div id="playlistAudios" class="space-y-2"></div>
          </div>
        </div>
      </div>
      <div class="flex-shrink-0 flex items-center justify-end gap-3 p-4 sm:px-6 border-t border-gray-700">
        <button onclick="closeViewPlaylistModal()" class="px-5 py-2.5 text-sm font-medium text-gray-300 hover:text-white transition-colors">Close</button>
        <button id="editPlaylistBtn" class="px-5 py-2.5 text-sm font-medium bg-primary hover:bg-blue-600 text-white rounded-lg transition-colors">
          <i class="ti ti-pencil mr-1"></i> Edit
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let selectedVideos = [];
let selectedAudios = [];
let currentPlaylistId = null;
let allVideos = <%- JSON.stringify(videos || []) %>;
let allAudios = <%- JSON.stringify(audios || []) %>;
let currentTab = 'videos';

function matchesFolder(item, folderValue) {
  if (folderValue === 'all') return true;
  if (folderValue === 'unassigned') return !item.folder_id;
  return item.folder_id === folderValue;
}

function switchTab(tab) {
  currentTab = tab;
  const videosTab = document.getElementById('videosTab');
  const audiosTab = document.getElementById('audiosTab');
  const tabVideos = document.getElementById('tabVideos');
  const tabAudios = document.getElementById('tabAudios');
  
  if (tab === 'videos') {
    videosTab.classList.remove('hidden');
    audiosTab.classList.add('hidden');
    tabVideos.classList.add('active', 'text-primary', 'border-primary');
    tabVideos.classList.remove('text-gray-400', 'border-transparent');
    tabAudios.classList.remove('active', 'text-primary', 'border-primary');
    tabAudios.classList.add('text-gray-400', 'border-transparent');
  } else {
    videosTab.classList.add('hidden');
    audiosTab.classList.remove('hidden');
    tabAudios.classList.add('active', 'text-primary', 'border-primary');
    tabAudios.classList.remove('text-gray-400', 'border-transparent');
    tabVideos.classList.remove('active', 'text-primary', 'border-primary');
    tabVideos.classList.add('text-gray-400', 'border-transparent');
  }
}

function updateBadges() {
  document.getElementById('videoCountBadge').textContent = selectedVideos.length;
  document.getElementById('audioCountBadge').textContent = selectedAudios.length;
  document.getElementById('summaryVideos').textContent = selectedVideos.length;
  document.getElementById('summaryAudios').textContent = selectedAudios.length;
  
  const videoBadge = document.getElementById('videoCountBadge');
  const audioBadge = document.getElementById('audioCountBadge');
  
  if (selectedVideos.length > 0) {
    videoBadge.classList.remove('bg-gray-700', 'text-gray-400');
    videoBadge.classList.add('bg-primary/20', 'text-primary');
  } else {
    videoBadge.classList.add('bg-gray-700', 'text-gray-400');
    videoBadge.classList.remove('bg-primary/20', 'text-primary');
  }
  
  if (selectedAudios.length > 0) {
    audioBadge.classList.remove('bg-gray-700', 'text-gray-400');
    audioBadge.classList.add('bg-primary/20', 'text-primary');
  } else {
    audioBadge.classList.add('bg-gray-700', 'text-gray-400');
    audioBadge.classList.remove('bg-primary/20', 'text-primary');
  }
}

function openCreatePlaylistModal() {
  currentPlaylistId = null;
  selectedVideos = [];
  selectedAudios = [];
  document.getElementById('modalTitle').textContent = 'Create New Playlist';
  document.getElementById('submitButtonText').textContent = 'Create Playlist';
  document.getElementById('playlistForm').reset();
  document.getElementById('playlistId').value = '';
  switchTab('videos');
  updateSelectedVideosDisplay();
  updateAvailableVideosDisplay();
  updateSelectedAudiosDisplay();
  updateAvailableAudiosDisplay();
  updateBadges();
  const modal = document.getElementById('playlistModal');
  document.body.style.overflow = 'hidden';
  modal.classList.remove('hidden');
  requestAnimationFrame(() => modal.classList.add('active'));
}

function closePlaylistModal() {
  const modal = document.getElementById('playlistModal');
  modal.classList.remove('active');
  setTimeout(() => {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }, 200);
}

function closeViewPlaylistModal() {
  const modal = document.getElementById('viewPlaylistModal');
  modal.classList.remove('active');
  setTimeout(() => {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }, 200);
}

function addVideoToPlaylist(videoId) {
  const video = allVideos.find(v => v.id == videoId);
  if (video && !selectedVideos.find(v => v.id == videoId)) {
    selectedVideos.push(video);
    updateSelectedVideosDisplay();
    updateAvailableVideosDisplay();
    updateBadges();
  }
}

function addFolderVideos() {
  const folderValue = document.getElementById('videoFolderFilter')?.value || 'all';
  if (folderValue === 'all') {
    showToast('Please select a folder to add', 'error');
    return;
  }
  const existingIds = new Set(selectedVideos.map(v => v.id));
  const toAdd = allVideos.filter(video => matchesFolder(video, folderValue) && !existingIds.has(video.id));
  if (toAdd.length === 0) {
    showToast('No new videos found in this folder', 'info');
    return;
  }
  selectedVideos = [...selectedVideos, ...toAdd];
  updateSelectedVideosDisplay();
  updateAvailableVideosDisplay();
  updateBadges();
}

function removeVideoFromPlaylist(videoId) {
  selectedVideos = selectedVideos.filter(v => v.id != videoId);
  updateSelectedVideosDisplay();
  updateAvailableVideosDisplay();
  updateBadges();
}

function clearAllVideos() {
  selectedVideos = [];
  updateSelectedVideosDisplay();
  updateAvailableVideosDisplay();
  updateBadges();
}

function addAudioToPlaylist(audioId) {
  const audio = allAudios.find(a => a.id == audioId);
  if (audio && !selectedAudios.find(a => a.id == audioId)) {
    selectedAudios.push(audio);
    updateSelectedAudiosDisplay();
    updateAvailableAudiosDisplay();
    updateBadges();
  }
}

function addFolderAudios() {
  const folderValue = document.getElementById('audioFolderFilter')?.value || 'all';
  if (folderValue === 'all') {
    showToast('Please select a folder to add', 'error');
    return;
  }
  const existingIds = new Set(selectedAudios.map(a => a.id));
  const toAdd = allAudios.filter(audio => matchesFolder(audio, folderValue) && !existingIds.has(audio.id));
  if (toAdd.length === 0) {
    showToast('No new audio files found in this folder', 'info');
    return;
  }
  selectedAudios = [...selectedAudios, ...toAdd];
  updateSelectedAudiosDisplay();
  updateAvailableAudiosDisplay();
  updateBadges();
}

function removeAudioFromPlaylist(audioId) {
  selectedAudios = selectedAudios.filter(a => a.id != audioId);
  updateSelectedAudiosDisplay();
  updateAvailableAudiosDisplay();
  updateBadges();
}

function clearAllAudios() {
  selectedAudios = [];
  updateSelectedAudiosDisplay();
  updateAvailableAudiosDisplay();
  updateBadges();
}

function formatDuration(seconds) {
  if (!seconds) return '0:00';
  const mins = Math.floor(seconds / 60);
  const secs = Math.floor(seconds % 60);
  return `${mins}:${String(secs).padStart(2, '0')}`;
}

function updateSelectedVideosDisplay() {
  renderSelectedVideos();
  setTimeout(() => initializeDragAndDrop(), 50);
}

function updateAvailableVideosDisplay() {
  const container = document.getElementById('availableVideos');
  const searchTerm = document.getElementById('searchVideos')?.value?.toLowerCase() || '';
  const folderValue = document.getElementById('videoFolderFilter')?.value || 'all';
  const selectedIds = selectedVideos.map(v => v.id);
  const available = allVideos.filter(v => !selectedIds.includes(v.id)
    && v.title.toLowerCase().includes(searchTerm)
    && matchesFolder(v, folderValue));
  
  if (available.length === 0) {
    container.innerHTML = `<div class="text-center py-8 text-gray-400">
      <i class="ti ti-${selectedIds.length === allVideos.length ? 'check' : 'search'} text-3xl mb-2"></i>
      <p class="text-sm">${selectedIds.length === allVideos.length ? 'All videos added' : 'No videos found'}</p>
    </div>`;
  } else {
    container.innerHTML = available.map(video => `
      <button type="button" class="w-full flex items-center gap-2 p-2 rounded hover:bg-dark-600 transition-colors text-left" 
              data-video-id="${video.id}" onclick="addVideoToPlaylist('${video.id}')">
        <div class="w-14 h-10 bg-dark-800 rounded flex-shrink-0 overflow-hidden">
          <img src="${video.thumbnail_path}" alt="${video.title}" class="w-full h-full object-cover" onerror="this.src='/images/default-thumbnail.jpg'">
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-white truncate">${video.title}</p>
          <p class="text-xs text-gray-400">${formatDuration(video.duration)}</p>
          <p class="text-xs text-gray-500 flex items-center gap-1">
            <i class="ti ti-folder text-xs"></i>
            <span class="truncate">${video.folder_name || 'Unsorted'}</span>
          </p>
        </div>
        <i class="ti ti-plus text-gray-400"></i>
      </button>
    `).join('');
  }
}

function updateSelectedAudiosDisplay() {
  renderSelectedAudios();
  setTimeout(() => initializeAudioDragAndDrop(), 50);
}

function updateAvailableAudiosDisplay() {
  const container = document.getElementById('availableAudios');
  const searchTerm = document.getElementById('searchAudios')?.value?.toLowerCase() || '';
  const folderValue = document.getElementById('audioFolderFilter')?.value || 'all';
  const selectedIds = selectedAudios.map(a => a.id);
  const available = allAudios.filter(a => !selectedIds.includes(a.id)
    && a.title.toLowerCase().includes(searchTerm)
    && matchesFolder(a, folderValue));
  
  if (available.length === 0) {
    if (allAudios.length === 0) {
      container.innerHTML = `<div class="text-center py-8 text-gray-400">
        <i class="ti ti-music-off text-3xl mb-2"></i>
        <p class="text-sm">No audio files available</p>
        <a href="/gallery" class="text-xs text-primary hover:underline mt-1 inline-block">Upload audio in Gallery</a>
      </div>`;
    } else {
      container.innerHTML = `<div class="text-center py-8 text-gray-400">
        <i class="ti ti-${selectedIds.length === allAudios.length ? 'check' : 'search'} text-3xl mb-2"></i>
        <p class="text-sm">${selectedIds.length === allAudios.length ? 'All audio added' : 'No audio found'}</p>
      </div>`;
    }
  } else {
    container.innerHTML = available.map(audio => `
      <button type="button" class="w-full flex items-center gap-2 p-2 rounded hover:bg-dark-600 transition-colors text-left" 
              data-audio-id="${audio.id}" onclick="addAudioToPlaylist('${audio.id}')">
        <div class="w-10 h-10 bg-dark-800 rounded-full flex-shrink-0 flex items-center justify-center">
          <i class="ti ti-music text-gray-400"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium text-white truncate">${audio.title}</p>
          <p class="text-xs text-gray-400">${formatDuration(audio.duration)}</p>
          <p class="text-xs text-gray-500 flex items-center gap-1">
            <i class="ti ti-folder text-xs"></i>
            <span class="truncate">${audio.folder_name || 'Unsorted'}</span>
          </p>
        </div>
        <i class="ti ti-plus text-gray-400"></i>
      </button>
    `).join('');
  }
}

function editPlaylist(playlistId) {
  fetch(`/api/playlists/${playlistId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const playlist = data.playlist;
        currentPlaylistId = playlistId;
        selectedVideos = playlist.videos || [];
        selectedAudios = playlist.audios || [];
        
        document.getElementById('modalTitle').textContent = 'Edit Playlist';
        document.getElementById('submitButtonText').textContent = 'Update Playlist';
        document.getElementById('playlistId').value = playlistId;
        document.getElementById('playlistName').value = playlist.name;
        document.getElementById('playlistDescription').value = playlist.description || '';
        document.getElementById('playlistShuffle').value = (playlist.shuffle || playlist.is_shuffle) ? "true" : "false";
        
        switchTab('videos');
        updateSelectedVideosDisplay();
        updateAvailableVideosDisplay();
        updateSelectedAudiosDisplay();
        updateAvailableAudiosDisplay();
        updateBadges();
        
        const modal = document.getElementById('playlistModal');
        document.body.style.overflow = 'hidden';
        modal.classList.remove('hidden');
        requestAnimationFrame(() => modal.classList.add('active'));
      }
    })
    .catch(error => {
      console.error('Error loading playlist:', error);
      showToast('Error loading playlist', 'error');
    });
}

function viewPlaylist(playlistId) {
  fetch(`/api/playlists/${playlistId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const playlist = data.playlist;
        const videos = playlist.videos || [];
        const audios = playlist.audios || [];
        
        document.getElementById('viewPlaylistTitle').textContent = playlist.name;
        document.getElementById('viewPlaylistDescription').textContent = playlist.description || 'No description';
        document.getElementById('viewVideoCount').innerHTML = `<i class="ti ti-video"></i> ${videos.length} videos`;
        document.getElementById('viewAudioCount').innerHTML = `<i class="ti ti-music"></i> ${audios.length} audio`;
        
        const playbackModeEl = document.getElementById('viewPlaybackMode');
        playbackModeEl.innerHTML = (playlist.shuffle || playlist.is_shuffle)
          ? '<i class="ti ti-arrows-shuffle"></i> Shuffle'
          : '<i class="ti ti-list-numbers"></i> Sequential';
        
        const videosContainer = document.getElementById('playlistVideos');
        if (videos.length > 0) {
          videosContainer.innerHTML = videos.map((video, index) => `
            <div class="flex items-center gap-3 p-3 bg-gray-700 rounded">
              <span class="text-gray-400 text-sm w-6">${index + 1}</span>
              <img src="${video.thumbnail_path}" alt="${video.title}" class="w-16 h-10 object-cover rounded" onerror="this.src='/images/default-thumbnail.jpg'">
              <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${video.title}</p>
                <p class="text-xs text-gray-400">${formatDuration(video.duration)}</p>
              </div>
            </div>
          `).join('');
        } else {
          videosContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No videos in this playlist</p>';
        }
        
        const audiosSection = document.getElementById('playlistAudiosSection');
        const audiosContainer = document.getElementById('playlistAudios');
        if (audios.length > 0) {
          audiosSection.classList.remove('hidden');
          audiosContainer.innerHTML = audios.map((audio, index) => `
            <div class="flex items-center gap-3 p-3 bg-gray-700 rounded">
              <span class="text-gray-400 text-sm w-6">${index + 1}</span>
              <div class="w-10 h-10 bg-dark-800 rounded-full flex items-center justify-center">
                <i class="ti ti-music text-gray-400"></i>
              </div>
              <div class="flex-1 min-w-0">
                <p class="font-medium truncate">${audio.title}</p>
                <p class="text-xs text-gray-400">${formatDuration(audio.duration)}</p>
              </div>
            </div>
          `).join('');
        } else {
          audiosSection.classList.add('hidden');
        }
        
        document.getElementById('editPlaylistBtn').onclick = () => {
          closeViewPlaylistModal();
          editPlaylist(playlistId);
        };
        
        const modal = document.getElementById('viewPlaylistModal');
        document.body.style.overflow = 'hidden';
        modal.classList.remove('hidden');
        requestAnimationFrame(() => modal.classList.add('active'));
      }
    })
    .catch(error => {
      console.error('Error loading playlist:', error);
      showToast('Error loading playlist', 'error');
    });
}

function deletePlaylist(playlistId, playlistName) {
  if (confirm(`Are you sure you want to delete "${playlistName}"?`)) {
    fetch(`/api/playlists/${playlistId}`, { method: 'DELETE' })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Playlist deleted successfully', 'success');
          location.reload();
        } else {
          showToast(data.message || 'Error deleting playlist', 'error');
        }
      })
      .catch(error => {
        console.error('Error deleting playlist:', error);
        showToast('Error deleting playlist', 'error');
      });
  }
}

function submitPlaylist() {
  const name = document.getElementById('playlistName').value.trim();
  if (!name) {
    showToast('Please enter a playlist name', 'error');
    return;
  }
  if (selectedVideos.length === 0) {
    showToast('Please add at least one video', 'error');
    switchTab('videos');
    return;
  }
  
  const playlistData = {
    name: name,
    description: document.getElementById('playlistDescription').value.trim(),
    shuffle: document.getElementById('playlistShuffle').value === 'true',
    videos: selectedVideos.map(v => v.id),
    audios: selectedAudios.map(a => a.id)
  };
  
  const url = currentPlaylistId ? `/api/playlists/${currentPlaylistId}` : '/api/playlists';
  const method = currentPlaylistId ? 'PUT' : 'POST';
  
  fetch(url, {
    method: method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(playlistData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showToast(currentPlaylistId ? 'Playlist updated successfully' : 'Playlist created successfully', 'success');
      closePlaylistModal();
      location.reload();
    } else {
      showToast(data.message || 'Error saving playlist', 'error');
    }
  })
  .catch(error => {
    console.error('Error saving playlist:', error);
    showToast('Error saving playlist', 'error');
  });
}

document.getElementById('searchVideos').addEventListener('input', updateAvailableVideosDisplay);
document.getElementById('searchAudios').addEventListener('input', updateAvailableAudiosDisplay);
document.getElementById('videoFolderFilter').addEventListener('change', updateAvailableVideosDisplay);
document.getElementById('audioFolderFilter').addEventListener('change', updateAvailableAudiosDisplay);

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg text-white z-50 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

let videoSortable = null;
let audioSortable = null;

function initializeDragAndDrop() {
  const container = document.getElementById('selectedVideos');
  if (!container) return;
  
  if (videoSortable) {
    videoSortable.destroy();
    videoSortable = null;
  }
  
  if (selectedVideos.length > 0) {
    videoSortable = new Sortable(container, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      handle: '.cursor-move',
      onEnd: function(evt) {
        if (evt.oldIndex !== evt.newIndex) {
          const moved = selectedVideos.splice(evt.oldIndex, 1)[0];
          selectedVideos.splice(evt.newIndex, 0, moved);
          renderSelectedVideos();
        }
      }
    });
  }
}

function initializeAudioDragAndDrop() {
  const container = document.getElementById('selectedAudios');
  if (!container) return;
  
  if (audioSortable) {
    audioSortable.destroy();
    audioSortable = null;
  }
  
  if (selectedAudios.length > 0) {
    audioSortable = new Sortable(container, {
      animation: 150,
      ghostClass: 'sortable-ghost',
      handle: '.cursor-move',
      onEnd: function(evt) {
        if (evt.oldIndex !== evt.newIndex) {
          const moved = selectedAudios.splice(evt.oldIndex, 1)[0];
          selectedAudios.splice(evt.newIndex, 0, moved);
          renderSelectedAudios();
        }
      }
    });
  }
}

function renderSelectedVideos() {
  const container = document.getElementById('selectedVideos');
  if (!container) return;
  
  if (selectedVideos.length === 0) {
    container.innerHTML = `<div id="noVideosMessage" class="text-center py-8 text-gray-400">
      <i class="ti ti-playlist text-3xl mb-2"></i>
      <p class="text-sm">Drag videos here or click to add</p>
    </div>`;
  } else {
    container.innerHTML = selectedVideos.map((video, index) => `
      <div class="flex items-center gap-2 p-2 bg-gray-600/50 rounded group" data-video-id="${video.id}">
        <div class="cursor-move text-gray-500 hover:text-gray-300"><i class="ti ti-grip-vertical"></i></div>
        <span class="text-xs text-gray-500 w-5">${index + 1}</span>
        <img src="${video.thumbnail_path}" alt="${video.title}" class="w-12 h-8 object-cover rounded" onerror="this.src='/images/default-thumbnail.jpg'">
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">${video.title}</p>
          <p class="text-xs text-gray-400">${formatDuration(video.duration)}</p>
        </div>
        <button type="button" onclick="removeVideoFromPlaylist('${video.id}')" class="text-gray-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
          <i class="ti ti-x"></i>
        </button>
      </div>
    `).join('');
  }
}

function renderSelectedAudios() {
  const container = document.getElementById('selectedAudios');
  if (!container) return;
  
  if (selectedAudios.length === 0) {
    container.innerHTML = `<div id="noAudiosMessage" class="text-center py-8 text-gray-400">
      <i class="ti ti-music text-3xl mb-2"></i>
      <p class="text-sm">No background music selected</p>
      <p class="text-xs text-gray-500 mt-1">This is optional</p>
    </div>`;
  } else {
    container.innerHTML = selectedAudios.map((audio, index) => `
      <div class="flex items-center gap-2 p-2 bg-gray-600/50 rounded group" data-audio-id="${audio.id}">
        <div class="cursor-move text-gray-500 hover:text-gray-300"><i class="ti ti-grip-vertical"></i></div>
        <span class="text-xs text-gray-500 w-5">${index + 1}</span>
        <div class="w-8 h-8 bg-dark-800 rounded-full flex-shrink-0 flex items-center justify-center">
          <i class="ti ti-music text-gray-400 text-sm"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-sm font-medium truncate">${audio.title}</p>
          <p class="text-xs text-gray-400">${formatDuration(audio.duration)}</p>
        </div>
        <button type="button" onclick="removeAudioFromPlaylist('${audio.id}')" class="text-gray-400 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">
          <i class="ti ti-x"></i>
        </button>
      </div>
    `).join('');
  }
}

function filterPlaylists() {
  const searchTerm = document.getElementById('searchPlaylists').value.toLowerCase();
  const sortBy = document.getElementById('sortPlaylists').value;
  const playlistCards = document.querySelectorAll('.playlist-card');
  let visibleCards = [];
  
  playlistCards.forEach(card => {
    const name = card.querySelector('h3').textContent.toLowerCase();
    const desc = card.querySelector('p').textContent.toLowerCase();
    if (name.includes(searchTerm) || desc.includes(searchTerm)) {
      visibleCards.push(card);
    }
  });
  
  if (visibleCards.length > 0) {
    const container = document.getElementById('playlistsContainer');
    visibleCards.sort((a, b) => {
      const aName = a.querySelector('h3').textContent;
      const bName = b.querySelector('h3').textContent;
      switch(sortBy) {
        case 'name': return aName.localeCompare(bName);
        case 'oldest': return new Date(a.dataset.createdAt) - new Date(b.dataset.createdAt);
        default: return new Date(b.dataset.updatedAt) - new Date(a.dataset.updatedAt);
      }
    });
    visibleCards.forEach(card => container.appendChild(card));
    allPlaylistCards = visibleCards;
  } else {
    allPlaylistCards = [];
  }
  
  currentPage = 1;
  updatePagination();
}

document.getElementById('searchPlaylists').addEventListener('input', filterPlaylists);
document.getElementById('sortPlaylists').addEventListener('change', filterPlaylists);

let currentPage = 1;
const itemsPerPage = 8;
let allPlaylistCards = [];

function initializePagination() {
  allPlaylistCards = Array.from(document.querySelectorAll('.playlist-card'));
  updatePagination();
}

function updatePagination() {
  const totalItems = allPlaylistCards.length;
  const totalPages = Math.ceil(totalItems / itemsPerPage);
  const start = (currentPage - 1) * itemsPerPage + 1;
  const end = Math.min(currentPage * itemsPerPage, totalItems);
  
  document.getElementById('paginationInfo').textContent = totalItems > 0 
    ? `Showing ${start}-${end} of ${totalItems} playlists` 
    : 'No playlists found';
  
  allPlaylistCards.forEach((card, index) => {
    card.style.display = (index >= (currentPage - 1) * itemsPerPage && index < currentPage * itemsPerPage) ? 'block' : 'none';
  });
  
  renderPaginationControls(totalPages);
}

function renderPaginationControls(totalPages) {
  const container = document.getElementById('paginationControls');
  container.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  const prev = document.createElement('button');
  prev.className = `w-9 h-9 flex items-center justify-center rounded-lg ${currentPage === 1 ? 'bg-dark-700 text-gray-600 cursor-not-allowed' : 'bg-dark-700 hover:bg-dark-600 text-gray-400 hover:text-white transition-colors'}`;
  prev.innerHTML = '<i class="ti ti-chevron-left"></i>';
  prev.disabled = currentPage === 1;
  prev.addEventListener('click', () => { if (currentPage > 1) { currentPage--; updatePagination(); } });
  container.appendChild(prev);

  let startPage = Math.max(1, currentPage - 2);
  let endPage = Math.min(totalPages, startPage + 4);
  if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);

  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.className = `w-9 h-9 flex items-center justify-center rounded-lg ${i === currentPage ? 'bg-primary text-white' : 'bg-dark-700 hover:bg-dark-600 text-gray-400 hover:text-white transition-colors'}`;
    btn.textContent = i;
    btn.addEventListener('click', () => { currentPage = i; updatePagination(); });
    container.appendChild(btn);
  }

  const next = document.createElement('button');
  next.className = `w-9 h-9 flex items-center justify-center rounded-lg ${currentPage === totalPages ? 'bg-dark-700 text-gray-600 cursor-not-allowed' : 'bg-dark-700 hover:bg-dark-600 text-gray-400 hover:text-white transition-colors'}`;
  next.innerHTML = '<i class="ti ti-chevron-right"></i>';
  next.disabled = currentPage === totalPages;
  next.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; updatePagination(); } });
  container.appendChild(next);
}

function changePage(direction) {
  const totalPages = Math.ceil(allPlaylistCards.length / itemsPerPage);
  const newPage = currentPage + direction;
  if (newPage >= 1 && newPage <= totalPages) {
    currentPage = newPage;
    updatePagination();
  }
}

function goToPage(page) {
  const totalPages = Math.ceil(allPlaylistCards.length / itemsPerPage);
  if (page >= 1 && page <= totalPages) {
    currentPage = page;
    updatePagination();
  }
}

document.addEventListener('DOMContentLoaded', initializePagination);
</script>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
.sortable-ghost { opacity: 0.4; background: #374151; }
.custom-scrollbar { scrollbar-width: thin; scrollbar-color: rgba(156, 163, 175, 0.3) transparent; }
.custom-scrollbar::-webkit-scrollbar { width: 6px; }
.custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
.custom-scrollbar::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.3); border-radius: 20px; }
.modal-overlay .modal-container { transform: scale(0.95); opacity: 0; transition: transform 0.2s ease, opacity 0.2s ease; }
.modal-overlay.active .modal-container { transform: scale(1); opacity: 1; }
</style>
